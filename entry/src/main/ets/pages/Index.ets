import { TransactionListPage } from './TransactionListPage';
import { BudgetPage } from './BudgetPage';
import { StatisticsPage } from './StatisticsPage';
import { SettingsPage } from './SettingsPage';
import { DataService } from '../services/DataService';
import { Settings } from '../models/Settings';

@Entry
@Component
struct Index {
  @State currentTab: string = 'details'; // 'details' | 'stats' | 'budget' | 'settings'
  @State refreshKey: number = 0; // ç”¨äºå¼ºåˆ¶åˆ·æ–°å­ç»„ä»¶
  private dataService: DataService = DataService.getInstance();
  private hasLoadedSettings: boolean = false;

  async aboutToAppear(): Promise<void> {
    // åŠ è½½è®¾ç½®å¹¶åº”ç”¨é»˜è®¤é¡µé¢
    if (!this.hasLoadedSettings) {
      const settings: Settings = await this.dataService.getSettings();
      this.currentTab = settings.defaultPage;
      this.hasLoadedSettings = true;
    }
  }

  async onPageShow(): Promise<void> {
    // ä»ç¼–è¾‘é¡µæˆ–è®¾ç½®é¡µè¿”å›æ—¶åˆ·æ–°
    this.refreshKey++;
    
    // é‡æ–°åŠ è½½è®¾ç½®ï¼ˆå¯èƒ½åœ¨è®¾ç½®é¡µä¿®æ”¹äº†é»˜è®¤é¡µé¢ï¼Œä½†ä¸åˆ‡æ¢å½“å‰æ ‡ç­¾ï¼‰
    const settings: Settings = await this.dataService.getSettings();
    // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œåˆ‡æ¢currentTabï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æ­£åœ¨æµè§ˆå…¶ä»–é¡µé¢
  }

  navigateToEdit(): void {
    const router = this.getUIContext().getRouter();
    router.pushUrl({ url: 'pages/TransactionEditPage' }).catch((err: Error) => {
      console.error('Navigate failed:', err);
    });
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // ä¸»å†…å®¹åŒºï¼ˆä½¿ç”¨Stackè®©å†…å®¹å¡«å……æ•´ä¸ªç©ºé—´ï¼‰
      Column() {
        if (this.currentTab === 'details') {
          TransactionListPage({ refreshTrigger: this.refreshKey })
        } else if (this.currentTab === 'stats') {
          StatisticsPage({ refreshTrigger: this.refreshKey })
        } else if (this.currentTab === 'budget') {
          BudgetPage({ refreshTrigger: this.refreshKey })
        } else if (this.currentTab === 'settings') {
          SettingsPage({ refreshTrigger: this.refreshKey })
        }
      }
      .width('100%')
      .height('100%')
      .padding({ bottom: 64 })

      // åº•éƒ¨å¯¼èˆªåŒºåŸŸï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰
      Column() {
        Row() {
          // æ˜ç»†
          Column() {
            Text('ğŸ“Š')
              .fontSize(20)
              .margin({ bottom: 4 })
            Text('æ˜ç»†')
              .fontSize(12)
              .fontColor(this.currentTab === 'details' ? '#4CAF50' : '#999999')
          }
          .width('20%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .padding({ top: 8, bottom: 8 })
          .onClick(() => { this.currentTab = 'details'; })

          // ç»Ÿè®¡
          Column() {
            Text('ğŸ“ˆ')
              .fontSize(20)
              .margin({ bottom: 4 })
            Text('ç»Ÿè®¡')
              .fontSize(12)
              .fontColor(this.currentTab === 'stats' ? '#4CAF50' : '#999999')
          }
          .width('20%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .padding({ top: 8, bottom: 8 })
          .onClick(() => { this.currentTab = 'stats'; })

          // ä¸­é—´å¿«æ·è®°è´¦å ä½ï¼ˆç©ºåˆ—ï¼Œç”¨äºå±…ä¸­æ‚¬æµ®æŒ‰é’®ï¼‰
          Column() {
            Text('')
              .fontSize(12)
          }
          .width('20%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)

          // é¢„ç®—
          Column() {
            Text('ğŸ’°')
              .fontSize(20)
              .margin({ bottom: 4 })
            Text('é¢„ç®—')
              .fontSize(12)
              .fontColor(this.currentTab === 'budget' ? '#4CAF50' : '#999999')
          }
          .width('20%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .padding({ top: 8, bottom: 8 })
          .onClick(() => { this.currentTab = 'budget'; })

          // è®¾ç½®
          Column() {
            Text('âš™ï¸')
              .fontSize(20)
              .margin({ bottom: 4 })
            Text('è®¾ç½®')
              .fontSize(12)
              .fontColor(this.currentTab === 'settings' ? '#4CAF50' : '#999999')
          }
          .width('20%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .padding({ top: 8, bottom: 8 })
          .onClick(() => { this.currentTab = 'settings'; })
        }
        .width('100%')
        .height(64)
        .backgroundColor('#ffffff')
        .borderWidth({ top: 1 })
        .borderColor('#f0f0f0')
        .shadow({ radius: 4, color: '#00000010', offsetY: -2 })

        // åº•éƒ¨ä¸­å¤®å¿«æ·è®°è´¦æ‚¬æµ®æŒ‰é’®
        Button() {
          Text('+')
            .fontSize(32)
            .fontColor('#ffffff')
            .fontWeight(FontWeight.Bold)
        }
        .width(64)
        .height(64)
        .borderRadius(32)
        .backgroundColor('#4CAF50')
        .shadow({ radius: 8, color: '#00000020', offsetY: 2 })
        .position({ x: '50%', y: 20 })
        .translate({ x: '-50%', y: '-50%' })
        .onClick(() => this.navigateToEdit())
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
  }
}