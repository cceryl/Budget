import { Transaction } from '../models/Transaction';
import { Category } from '../models/Category';
import { Budget, PeriodTime } from '../models/Budget';
import { DataService } from '../services/DataService';

/**
 * åˆ†ç±»ç»Ÿè®¡è§†å›¾æ¨¡å‹
 */
@Observed
class CategoryStatViewModel {
  public categoryId: string;
  public categoryName: string;
  public amount: number; // é‡‘é¢ï¼ˆåˆ†ï¼‰
  public percentage: number; // å æ¯”
  public color: string; // æ˜¾ç¤ºé¢œè‰²

  constructor(categoryId: string, categoryName: string, amount: number, percentage: number, color: string) {
    this.categoryId = categoryId;
    this.categoryName = categoryName;
    this.amount = amount;
    this.percentage = percentage;
    this.color = color;
  }
}

/**
 * è¶‹åŠ¿æ•°æ®ç‚¹
 */
@Observed
class TrendDataPoint {
  public date: string; // æ—¥æœŸæ ‡ç­¾
  public amount: number; // é‡‘é¢ï¼ˆåˆ†ï¼‰
  public timestamp: number; // æ—¶é—´æˆ³

  constructor(date: string, amount: number, timestamp: number) {
    this.date = date;
    this.amount = amount;
    this.timestamp = timestamp;
  }
}

@Component
export struct StatisticsPage {
  @State currentPeriod: string = 'month'; // 'week', 'month', 'year'
  @State totalIncome: number = 0; // æ”¶å…¥æ€»é¢ï¼ˆåˆ†ï¼‰
  @State totalExpense: number = 0; // æ”¯å‡ºæ€»é¢ï¼ˆåˆ†ï¼‰
  @State balance: number = 0; // ç»“ä½™ï¼ˆåˆ†ï¼‰
  @State expenseCategories: CategoryStatViewModel[] = []; // æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡
  @State incomeCategories: CategoryStatViewModel[] = []; // æ”¶å…¥åˆ†ç±»ç»Ÿè®¡
  @State trendData: TrendDataPoint[] = []; // è¶‹åŠ¿æ•°æ®
  @State showIncomeStats: boolean = false; // æ˜¯å¦æ˜¾ç¤ºæ”¶å…¥ç»Ÿè®¡ï¼ˆé»˜è®¤æ˜¾ç¤ºæ”¯å‡ºï¼‰
  @State currencySymbol: string = 'Â¥'; // è´§å¸ç¬¦å·
  @State showIncomeTrend: boolean = false; // æ˜¯å¦æ˜¾ç¤ºæ”¶å…¥è¶‹åŠ¿ï¼ˆé»˜è®¤æ˜¾ç¤ºæ”¯å‡ºï¼‰
  @State dataRefreshKey: number = 0; // æ•°æ®åˆ·æ–°è®¡æ•°å™¨ï¼Œç”¨äºå¼ºåˆ¶åˆ·æ–°UI
  @Prop @Watch('onRefreshTriggerChange') refreshTrigger: number = 0;
  
  private dataService: DataService = DataService.getInstance();
  private categories: Category[] = [];
  private readonly CHART_COLORS: string[] = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF9F40'
  ];

  aboutToAppear(): void {
    this.initializeAndLoadData();
  }

  async initializeAndLoadData(): Promise<void> {
    await this.dataService.waitForInitialization();
    await this.loadData();
  }

  onRefreshTriggerChange(): void {
    this.loadData();
  }

  async loadData(): Promise<void> {
    // å…ˆæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Œç¡®ä¿UIå®Œå…¨åˆ·æ–°
    this.trendData = [];
    this.expenseCategories = [];
    this.incomeCategories = [];
    this.totalIncome = 0;
    this.totalExpense = 0;
    this.balance = 0;
    
    // åŠ è½½è´§å¸è®¾ç½®
    const settings = await this.dataService.getSettings();
    this.currencySymbol = settings.currency;
    
    // åŠ è½½åˆ†ç±»æ•°æ®
    this.categories = await this.dataService.getAllCategories();
    
    // è®¡ç®—å½“å‰å‘¨æœŸ
    const periodTime = Budget.calculatePeriod(this.currentPeriod);
    
    // åŠ è½½äº¤æ˜“æ•°æ®
    const allTransactions = await this.dataService.getAllTransactions();
    
    // ç­›é€‰å½“å‰å‘¨æœŸçš„äº¤æ˜“
    const periodTransactions = allTransactions.filter(t =>
      t.date >= periodTime.start && t.date < periodTime.end
    );

    // è®¡ç®—æ€»è§ˆæ•°æ®
    this.calculateOverview(periodTransactions);
    
    // è®¡ç®—åˆ†ç±»ç»Ÿè®¡
    this.calculateCategoryStats(periodTransactions);
    
    // è®¡ç®—è¶‹åŠ¿æ•°æ®
    this.calculateTrendData(periodTransactions, periodTime);
    
    // é€’å¢åˆ·æ–°è®¡æ•°å™¨ï¼Œå¼ºåˆ¶åˆ·æ–°UI
    this.dataRefreshKey++;
  }

  /**
   * è®¡ç®—æ€»è§ˆæ•°æ®
   */
  calculateOverview(transactions: Transaction[]): void {
    let income = 0;
    let expense = 0;

    for (const t of transactions) {
      if (t.type === 'income') {
        income += t.amount;
      } else if (t.type === 'expense') {
        expense += t.amount;
      }
    }

    this.totalIncome = income;
    this.totalExpense = expense;
    this.balance = income - expense;
  }

  /**
   * è®¡ç®—åˆ†ç±»ç»Ÿè®¡
   */
  calculateCategoryStats(transactions: Transaction[]): void {
    // åˆ†åˆ«ç»Ÿè®¡æ”¶å…¥å’Œæ”¯å‡º
    const expenseMap = new Map<string, number>();
    const incomeMap = new Map<string, number>();

    for (const t of transactions) {
      if (t.type === 'expense') {
        const current = expenseMap.get(t.categoryId);
        if (current !== undefined) {
          expenseMap.set(t.categoryId, current + t.amount);
        } else {
          expenseMap.set(t.categoryId, t.amount);
        }
      } else if (t.type === 'income') {
        const current = incomeMap.get(t.categoryId);
        if (current !== undefined) {
          incomeMap.set(t.categoryId, current + t.amount);
        } else {
          incomeMap.set(t.categoryId, t.amount);
        }
      }
    }

    // æ„å»ºæ”¯å‡ºåˆ†ç±»è§†å›¾æ¨¡å‹
    const expenseVMs: CategoryStatViewModel[] = [];
    let colorIndex = 0;
    
    const expenseEntries: Array<[string, number]> = [];
    expenseMap.forEach((value, key) => {
      expenseEntries.push([key, value]);
    });
    
    for (const entry of expenseEntries) {
      const categoryId = entry[0];
      const amount = entry[1];
      const category = this.categories.find(c => c.id === categoryId);
      const categoryName = category ? category.name : 'æœªçŸ¥åˆ†ç±»';
      const percentage = this.totalExpense > 0 ? (amount / this.totalExpense) * 100 : 0;
      const color = this.CHART_COLORS[colorIndex % this.CHART_COLORS.length];
      
      expenseVMs.push(new CategoryStatViewModel(categoryId, categoryName, amount, percentage, color));
      colorIndex++;
    }
    
    // æŒ‰é‡‘é¢é™åºæ’åº
    expenseVMs.sort((a, b) => b.amount - a.amount);
    this.expenseCategories = expenseVMs;

    // æ„å»ºæ”¶å…¥åˆ†ç±»è§†å›¾æ¨¡å‹
    const incomeVMs: CategoryStatViewModel[] = [];
    colorIndex = 0;
    
    const incomeEntries: Array<[string, number]> = [];
    incomeMap.forEach((value, key) => {
      incomeEntries.push([key, value]);
    });
    
    for (const entry of incomeEntries) {
      const categoryId = entry[0];
      const amount = entry[1];
      const category = this.categories.find(c => c.id === categoryId);
      const categoryName = category ? category.name : 'æœªçŸ¥åˆ†ç±»';
      const percentage = this.totalIncome > 0 ? (amount / this.totalIncome) * 100 : 0;
      const color = this.CHART_COLORS[colorIndex % this.CHART_COLORS.length];
      
      incomeVMs.push(new CategoryStatViewModel(categoryId, categoryName, amount, percentage, color));
      colorIndex++;
    }
    
    // æŒ‰é‡‘é¢é™åºæ’åº
    incomeVMs.sort((a, b) => b.amount - a.amount);
    this.incomeCategories = incomeVMs;
  }

  /**
   * è®¡ç®—è¶‹åŠ¿æ•°æ®
   */
  calculateTrendData(transactions: Transaction[], periodTime: PeriodTime): void {
    const dataMap = new Map<string, number>();
    const targetType = this.showIncomeTrend ? 'income' : 'expense';
    
    // æ ¹æ®å‘¨æœŸç±»å‹å†³å®šåˆ†ç»„ç²’åº¦
    if (this.currentPeriod === 'week') {
      // æŒ‰å¤©åˆ†ç»„
      for (const t of transactions) {
        if (t.type === targetType) {
          const date = new Date(t.date);
          const dateKey = `${date.getMonth() + 1}/${date.getDate()}`;
          const current = dataMap.get(dateKey);
          if (current !== undefined) {
            dataMap.set(dateKey, current + t.amount);
          } else {
            dataMap.set(dateKey, t.amount);
          }
        }
      }
      
      // å¡«å……å®Œæ•´çš„7å¤©æ•°æ®
      const points: TrendDataPoint[] = [];
      const startDate = new Date(periodTime.start);
      for (let i = 0; i < 7; i++) {
        const currentDate = new Date(startDate.getTime());
        currentDate.setDate(currentDate.getDate() + i);
        const dateKey = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
        const amount = dataMap.get(dateKey);
        points.push(new TrendDataPoint(dateKey, amount !== undefined ? amount : 0, currentDate.getTime()));
      }
      this.trendData = points;
    } else if (this.currentPeriod === 'month') {
      // æŒ‰å¤©åˆ†ç»„ï¼ˆæ˜¾ç¤ºæœ¬æœˆæ¯ä¸€å¤©ï¼‰
      const startDate = new Date(periodTime.start);
      const targetMonth = startDate.getMonth();
      const targetYear = startDate.getFullYear();
      
      for (const t of transactions) {
        if (t.type === targetType) {
          const date = new Date(t.date);
          // ç¡®ä¿æ˜¯åŒä¸€ä¸ªæœˆ
          if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
            const dateKey = `${date.getDate()}`;
            const current = dataMap.get(dateKey);
            if (current !== undefined) {
              dataMap.set(dateKey, current + t.amount);
            } else {
              dataMap.set(dateKey, t.amount);
            }
          }
        }
      }
      
      // å¡«å……å®Œæ•´çš„æœˆä»½æ•°æ®
      const points: TrendDataPoint[] = [];
      const endDate = new Date(periodTime.end);
      const daysInMonth = Math.floor((endDate.getTime() - startDate.getTime()) / (24 * 60 * 60 * 1000));
      
      for (let i = 0; i < daysInMonth; i++) {
        const currentDate = new Date(startDate.getTime());
        currentDate.setDate(currentDate.getDate() + i);
        const dateKey = `${currentDate.getDate()}`;
        const amount = dataMap.get(dateKey);
        points.push(new TrendDataPoint(dateKey, amount !== undefined ? amount : 0, currentDate.getTime()));
      }
      this.trendData = points;
    } else if (this.currentPeriod === 'year') {
      // æŒ‰æœˆåˆ†ç»„
      for (const t of transactions) {
        if (t.type === targetType) {
          const date = new Date(t.date);
          const month = date.getMonth() + 1;
          const dateKey = `${month}`;
          const current = dataMap.get(dateKey);
          if (current !== undefined) {
            dataMap.set(dateKey, current + t.amount);
          } else {
            dataMap.set(dateKey, t.amount);
          }
        }
      }
      
      // å¡«å……å®Œæ•´çš„12ä¸ªæœˆæ•°æ®
      const points: TrendDataPoint[] = [];
      for (let i = 1; i <= 12; i++) {
        const dateKey = `${i}`;
        const displayKey = `${i}æœˆ`;
        const amount = dataMap.get(dateKey);
        const timestamp = new Date(periodTime.start).setMonth(i - 1);
        points.push(new TrendDataPoint(displayKey, amount !== undefined ? amount : 0, timestamp));
      }
      this.trendData = points;
    }
  }

  getPeriodText(): string {
    if (this.currentPeriod === 'week') {
      return 'æœ¬å‘¨ç»Ÿè®¡';
    } else if (this.currentPeriod === 'month') {
      return 'æœ¬æœˆç»Ÿè®¡';
    } else if (this.currentPeriod === 'year') {
      return 'æœ¬å¹´ç»Ÿè®¡';
    }
    return 'ç»Ÿè®¡';
  }

  /**
   * æ ¹æ®é‡‘é¢é•¿åº¦è®¡ç®—åˆé€‚çš„å­—å·ï¼ˆä¿æŒå¡ç‰‡é«˜åº¦ä¸€è‡´ï¼‰
   */
  calculateAmountFontSize(amount: number): number {
    const amountStr = `${this.currencySymbol}${(Math.abs(amount) / 100).toFixed(2)}`;
    const length = amountStr.length;
    
    if (length <= 8) {
      return 18; // çŸ­é‡‘é¢
    } else if (length <= 10) {
      return 16; // ä¸­ç­‰é•¿åº¦
    } else if (length <= 12) {
      return 14; // è¾ƒé•¿
    } else {
      return 10; // è¶…é•¿é‡‘é¢
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text(this.getPeriodText())
          .fontSize(26)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))

        Blank()

        // è´¢åŠ¡åŠ©æ‰‹æŒ‰é’®
        Button({ type: ButtonType.Circle }) {
          Text('ğŸ’¬')
            .fontSize(20)
        }
        .width(44)
        .height(44)
        .backgroundColor($r('app.color.primary_color'))
        .onClick(() => {
          this.getUIContext().getRouter().pushUrl({
            url: 'pages/ChatPage'
          });
        })
      }
      .width('100%')
      .height(64)
      .padding({ left: 20, right: 20 })
      .backgroundColor($r('app.color.background_primary'))

      // å‘¨æœŸé€‰æ‹©å™¨
      Row({ space: 12 }) {
        Button('å‘¨')
          .fontSize(14)
          .height(36)
          .padding({ left: 16, right: 16 })
          .backgroundColor(this.currentPeriod === 'week' ? $r('app.color.primary_color') : $r('app.color.button_secondary_bg'))
          .fontColor(this.currentPeriod === 'week' ? '#FFFFFF' : $r('app.color.button_secondary_text'))
          .borderRadius(18)
          .onClick(async () => {
            this.currentPeriod = 'week';
            await this.loadData();
          })

        Button('æœˆ')
          .fontSize(14)
          .height(36)
          .padding({ left: 16, right: 16 })
          .backgroundColor(this.currentPeriod === 'month' ? $r('app.color.primary_color') : $r('app.color.button_secondary_bg'))
          .fontColor(this.currentPeriod === 'month' ? '#FFFFFF' : $r('app.color.button_secondary_text'))
          .borderRadius(18)
          .onClick(async () => {
            this.currentPeriod = 'month';
            await this.loadData();
          })

        Button('å¹´')
          .fontSize(14)
          .height(36)
          .padding({ left: 16, right: 16 })
          .backgroundColor(this.currentPeriod === 'year' ? $r('app.color.primary_color') : $r('app.color.button_secondary_bg'))
          .fontColor(this.currentPeriod === 'year' ? '#FFFFFF' : $r('app.color.button_secondary_text'))
          .borderRadius(18)
          .onClick(async () => {
            this.currentPeriod = 'year';
            await this.loadData();
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor($r('app.color.background_primary'))

      // æ»šåŠ¨å†…å®¹åŒº
      Scroll() {
        Column() {
          // æ€»è§ˆæ¨¡å—
          this.OverviewSection()

          // åˆ†ç±»ç»Ÿè®¡æ¨¡å—
          this.CategoryStatsSection()

          // è¶‹åŠ¿å›¾æ¨¡å—
          this.TrendSection()
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor($r('app.color.background_secondary'))
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_secondary'))
  }

  /**
   * æ€»è§ˆæ¨¡å—
   */
  @Builder
  OverviewSection() {
    Column() {
      Text('æ€»è§ˆ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .width('100%')
        .margin({ bottom: 16 })

      // ä¸‰ä¸ªæŒ‡æ ‡å¡ç‰‡
      Row({ space: 12 }) {
        // æ”¶å…¥
        Column({ space: 8 }) {
          Text('æ”¶å…¥')
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
          Text(`${this.currencySymbol}${(this.totalIncome / 100).toFixed(2)}`)
            .fontSize(this.calculateAmountFontSize(this.totalIncome))
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.income_color'))
            .maxLines(1)
            .height(32)
            .width('100%')
            .textAlign(TextAlign.Center)
        }
        .layoutWeight(1)
        .padding(14)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetY: 2 })
        .alignItems(HorizontalAlign.Center)

        // æ”¯å‡º
        Column({ space: 8 }) {
          Text('æ”¯å‡º')
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
          Text(`${this.currencySymbol}${(this.totalExpense / 100).toFixed(2)}`)
            .fontSize(this.calculateAmountFontSize(this.totalExpense))
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.expense_color'))
            .maxLines(1)
            .height(32)
            .width('100%')
            .textAlign(TextAlign.Center)
        }
        .layoutWeight(1)
        .padding(14)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetY: 2 })
        .alignItems(HorizontalAlign.Center)

        // ç»“ä½™
        Column({ space: 8 }) {
          Text('ç»“ä½™')
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
          Text(`${this.currencySymbol}${(this.balance / 100).toFixed(2)}`)
            .fontSize(this.calculateAmountFontSize(this.balance))
            .fontWeight(FontWeight.Bold)
            .fontColor(this.balance >= 0 ? $r('app.color.income_color') : $r('app.color.expense_color'))
            .maxLines(1)
            .height(32)
            .width('100%')
            .textAlign(TextAlign.Center)
        }
        .layoutWeight(1)
        .padding(14)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetY: 2 })
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
  }

  /**
   * åˆ†ç±»ç»Ÿè®¡æ¨¡å—
   */
  @Builder
  CategoryStatsSection() {
    Column() {
      // æ ‡é¢˜å’Œåˆ‡æ¢æŒ‰é’®
      Row() {
        Text('åˆ†ç±»ç»Ÿè®¡')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))

        Blank()

        // æ”¶å…¥/æ”¯å‡ºåˆ‡æ¢
        Row({ space: 8 }) {
          Button('æ”¯å‡º')
            .fontSize(12)
            .height(32)
            .padding({ left: 14, right: 14 })
            .backgroundColor(!this.showIncomeStats ? $r('app.color.primary_color') : $r('app.color.button_secondary_bg'))
            .fontColor(!this.showIncomeStats ? '#FFFFFF' : $r('app.color.button_secondary_text'))
            .borderRadius(16)
            .onClick(() => {
              this.showIncomeStats = false;
            })

          Button('æ”¶å…¥')
            .fontSize(12)
            .height(32)
            .padding({ left: 14, right: 14 })
            .backgroundColor(this.showIncomeStats ? $r('app.color.primary_color') : $r('app.color.button_secondary_bg'))
            .fontColor(this.showIncomeStats ? '#FFFFFF' : $r('app.color.button_secondary_text'))
            .borderRadius(16)
            .onClick(() => {
              this.showIncomeStats = true;
            })
        }
      }
      .width('100%')
      .margin({ bottom: 16 })

      // é¥¼å›¾ï¼ˆç®€åŒ–ç‰ˆ - ä½¿ç”¨åœ†ç¯å›¾ï¼‰
      if (this.showIncomeStats) {
        if (this.incomeCategories.length > 0) {
          this.SimplePieChart()
        } else {
          this.EmptyDataPlaceholder('æš‚æ— æ”¶å…¥æ•°æ®')
        }
      } else {
        if (this.expenseCategories.length > 0) {
          this.SimplePieChart()
        } else {
          this.EmptyDataPlaceholder('æš‚æ— æ”¯å‡ºæ•°æ®')
        }
      }

      // åˆ†ç±»åˆ—è¡¨
      if (this.showIncomeStats) {
        this.CategoryList()
      } else {
        this.CategoryList()
      }
    }
    .width('100%')
    .padding(16)
    .margin({ top: 8 })
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetY: 2 })
  }

  /**
   * ç®€åŒ–ç‰ˆé¥¼å›¾ï¼ˆä½¿ç”¨å †å çš„è¿›åº¦æ¡è¡¨ç¤ºï¼‰
   */
  @Builder
  SimplePieChart() {
    Column() {
      // åœ†ç¯å›¾çš„æ›¿ä»£æ–¹æ¡ˆï¼šæ¨ªå‘å †å æ¡
      Row() {
        ForEach(this.showIncomeStats ? this.incomeCategories : this.expenseCategories, (cat: CategoryStatViewModel, index: number) => {
          if (index < 5) { // åªæ˜¾ç¤ºå‰5ä¸ªåˆ†ç±»
            Row()
              .width(`${cat.percentage}%`)
              .height(12)
              .backgroundColor(cat.color)
          }
        }, (cat: CategoryStatViewModel) => `${this.dataRefreshKey}-${cat.categoryId}`)
      }
      .width('100%')
      .borderRadius(6)
      .margin({ top: 16, bottom: 16 })

      // å›¾ä¾‹
      Column() {
        ForEach(this.showIncomeStats ? this.incomeCategories : this.expenseCategories, (cat: CategoryStatViewModel, index: number) => {
          if (index < 5) { // åªæ˜¾ç¤ºå‰5ä¸ªåˆ†ç±»
            Row() {
              Row()
                .width(12)
                .height(12)
                .backgroundColor(cat.color)
                .borderRadius(2)

              Text(cat.categoryName)
                .fontSize(14)
                .fontColor('#666666')
                .margin({ left: 8 })

              Blank()

              Text(`${cat.percentage.toFixed(1)}%`)
                .fontSize(14)
                .fontColor('#999999')
            }
            .width('100%')
            .margin({ bottom: 8 })
          }
        }, (cat: CategoryStatViewModel) => `${this.dataRefreshKey}-${cat.categoryId}`)

        // å¦‚æœåˆ†ç±»è¶…è¿‡5ä¸ªï¼Œæ˜¾ç¤º"å…¶ä»–"
        if ((this.showIncomeStats ? this.incomeCategories.length : this.expenseCategories.length) > 5) {
          Text(`...è¿˜æœ‰${(this.showIncomeStats ? this.incomeCategories.length : this.expenseCategories.length) - 5}ä¸ªåˆ†ç±»`)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 4 })
        }
      }
      .width('100%')
    }
    .width('100%')
  }

  /**
   * åˆ†ç±»åˆ—è¡¨
   */
  @Builder
  CategoryList() {
    Column() {
      Text('è¯¦ç»†åˆ—è¡¨')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .width('100%')
        .margin({ top: 20, bottom: 14 })

      ForEach(this.showIncomeStats ? this.incomeCategories : this.expenseCategories, (cat: CategoryStatViewModel) => {
        Column({ space: 8 }) {
          Row() {
            Row()
              .width(4)
              .height(16)
              .backgroundColor(cat.color)
              .borderRadius(2)
              .margin({ right: 10 })

            Text(cat.categoryName)
              .fontSize(15)
              .fontColor($r('app.color.text_primary'))

            Blank()

            Text(`${this.currencySymbol}${(cat.amount / 100).toFixed(2)}`)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')

          // å æ¯”æ¡
          Stack({ alignContent: Alignment.Start }) {
            Row()
              .width('100%')
              .height(6)
              .backgroundColor($r('app.color.button_secondary_bg'))
              .borderRadius(3)

            Row()
              .width(`${cat.percentage}%`)
              .height(6)
              .backgroundColor(cat.color)
              .borderRadius(3)
          }
          .width('100%')

          Text(`${cat.percentage.toFixed(1)}%`)
            .fontSize(12)
            .fontColor($r('app.color.text_tertiary'))
            .width('100%')
        }
        .width('100%')
        .padding({ top: 12, bottom: 12 })
        .borderWidth({ bottom: 1 })
        .borderColor($r('app.color.divider'))
      }, (cat: CategoryStatViewModel) => `${this.dataRefreshKey}-${cat.categoryId}`)
    }
    .width('100%')
  }

  /**
   * è¶‹åŠ¿å›¾æ¨¡å—
   */
  @Builder
  TrendSection() {
    Column() {
      // æ ‡é¢˜å’Œåˆ‡æ¢æŒ‰é’®
      Row() {
        Text('è¶‹åŠ¿åˆ†æ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))

        Blank()

        // æ”¶å…¥/æ”¯å‡ºåˆ‡æ¢
        Row({ space: 8 }) {
          Button('æ”¯å‡º')
            .fontSize(12)
            .height(32)
            .padding({ left: 14, right: 14 })
            .backgroundColor(!this.showIncomeTrend ? $r('app.color.primary_color') : $r('app.color.button_secondary_bg'))
            .fontColor(!this.showIncomeTrend ? '#FFFFFF' : $r('app.color.button_secondary_text'))
            .borderRadius(16)
            .onClick(() => {
              this.showIncomeTrend = false;
              this.loadData();
            })

          Button('æ”¶å…¥')
            .fontSize(12)
            .height(32)
            .padding({ left: 14, right: 14 })
            .backgroundColor(this.showIncomeTrend ? $r('app.color.primary_color') : $r('app.color.button_secondary_bg'))
            .fontColor(this.showIncomeTrend ? '#FFFFFF' : $r('app.color.button_secondary_text'))
            .borderRadius(16)
            .onClick(() => {
              this.showIncomeTrend = true;
              this.loadData();
            })
        }
      }
      .width('100%')
      .margin({ bottom: 16 })

      if (this.trendData.length > 0) {
        this.SimpleTrendChart()
      } else {
        this.EmptyDataPlaceholder(this.showIncomeTrend ? 'æš‚æ— æ”¶å…¥æ•°æ®' : 'æš‚æ— æ”¯å‡ºæ•°æ®')
      }
    }
    .width('100%')
    .padding(16)
    .margin({ top: 8, bottom: 16 })
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .shadow({ radius: 4, color: $r('app.color.shadow_light'), offsetY: 2 })
  }

  /**
   * è·å–è¶‹åŠ¿æ•°æ®çš„æœ€å¤§å€¼
   */
  getMaxTrendAmount(): number {
    let maxAmount = 0;
    for (const point of this.trendData) {
      if (point.amount > maxAmount) {
        maxAmount = point.amount;
      }
    }
    return maxAmount;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæ—¥æœŸæ ‡ç­¾ï¼ˆç”¨äºæœˆè§†å›¾ä¼˜åŒ–ï¼‰
   * åªæ˜¾ç¤º1å·å’Œè¢«5æ•´é™¤çš„æ—¥æœŸ
   */
  shouldShowDateLabel(dateStr: string): boolean {
    // å‘¨è§†å›¾å’Œå¹´è§†å›¾çš„æ—¥æœŸåŒ…å«éæ•°å­—å­—ç¬¦ï¼Œå…¨éƒ¨æ˜¾ç¤º
    if (dateStr.includes('/') || dateStr.includes('æœˆ')) {
      return true;
    }
    
    // æœˆè§†å›¾ï¼šåªæ˜¾ç¤ºçº¯æ•°å­—æ—¥æœŸ
    const day = parseInt(dateStr);
    if (isNaN(day)) {
      return true;
    }
    
    // æ˜¾ç¤º1å·å’Œè¢«5æ•´é™¤çš„æ—¥æœŸï¼ˆ5, 10, 15, 20, 25, 30ï¼‰
    return day === 1 || day % 5 === 0;
  }

  /**
   * ç®€åŒ–ç‰ˆè¶‹åŠ¿å›¾ï¼ˆä½¿ç”¨æŸ±çŠ¶å›¾ï¼‰
   */
  @Builder
  SimpleTrendChart() {
    Column() {
      if (this.getMaxTrendAmount() === 0) {
        this.EmptyDataPlaceholder(this.showIncomeTrend ? 'æš‚æ— æ”¶å…¥æ•°æ®' : 'æš‚æ— æ”¯å‡ºæ•°æ®')
      } else {
        // æŸ±çŠ¶å›¾
        Row({ space: 2 }) {
          ForEach(this.trendData, (point: TrendDataPoint) => {
            Column() {
              // æŸ±å­å®¹å™¨ï¼ˆå›ºå®šé«˜åº¦åŒºåŸŸï¼‰
              Column() {
                Column()
                  .width('100%')
                  .height(point.amount > 0 ? `${(point.amount / this.getMaxTrendAmount()) * 100}%` : '2%')
                  .backgroundColor(this.showIncomeTrend ? $r('app.color.income_color') : $r('app.color.accent_info'))
                  .borderRadius(5)
              }
              .width('100%')
              .height(170)
              .justifyContent(FlexAlign.End)

              // æ—¥æœŸæ ‡ç­¾å®¹å™¨
              Stack() {
                if (this.shouldShowDateLabel(point.date)) {
                  Text(point.date)
                    .fontSize(10)
                    .fontColor($r('app.color.text_tertiary'))
                    .textAlign(TextAlign.Center)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.None })
                    .clip(false)
                }
              }
              .width('200%')
              .height(24)
              .margin({ top: 6 })
              .clip(false)
            }
            .layoutWeight(1)
            .justifyContent(FlexAlign.End)
            .clip(false)
          }, (point: TrendDataPoint) => `${this.dataRefreshKey}-${point.timestamp}`)
        }
        .width('100%')
        .margin({ top: 16 })
        .height(200)

        // æ˜¾ç¤ºæœ€å¤§å€¼å‚è€ƒ
        Text(`æœ€é«˜: ${this.currencySymbol}${(this.getMaxTrendAmount() / 100).toFixed(2)}`)
          .fontSize(12)
          .fontColor($r('app.color.text_tertiary'))
          .margin({ top: 12 })
          .width('100%')
      }
    }
    .width('100%')
  }

  @Builder
  EmptyDataPlaceholder(message: string) {
    Column() {
      Text(message)
        .fontSize(14)
        .fontColor($r('app.color.text_tertiary'))
        .margin({ top: 40, bottom: 40 })
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
}
